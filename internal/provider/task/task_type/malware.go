/*
 * Copyright (c) 2019-present Sonatype, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package tasktype

import (
	"context"
	"fmt"
	"net/http"
	"terraform-provider-sonatyperepo/internal/provider/common"
	"terraform-provider-sonatyperepo/internal/provider/model"
	"time"

	"github.com/hashicorp/terraform-plugin-framework/diag"
	tfschema "github.com/hashicorp/terraform-plugin-framework/resource/schema"
	"github.com/hashicorp/terraform-plugin-framework/tfsdk"
	"github.com/hashicorp/terraform-plugin-framework/types"

	v3 "github.com/sonatype-nexus-community/nexus-repo-api-client-go/v3"

	"github.com/sonatype-nexus-community/terraform-provider-shared/schema"
)

// --------------------------------------------
// Malware Remediators
// --------------------------------------------
type MalwareRemediatorTask struct {
	BaseTaskType
}

func NewMalwareRemediatorTask() *MalwareRemediatorTask {
	return &MalwareRemediatorTask{
		BaseTaskType: BaseTaskType{
			publicName: "Automatic Malware Management",
			taskType:   common.TASK_TYPE_MALWARE_REMEDIATOR,
		},
	}
}

// --------------------------------------------
// Malware Remediators Functions
// --------------------------------------------
func (f *MalwareRemediatorTask) DoCreateRequest(plan any, apiClient *v3.APIClient, ctx context.Context, version common.SystemVersion) (*v3.CreateTask201Response, *http.Response, error) {
	// Cast to correct Plan Model Type
	planModel := (plan).(model.TaskMalwareRemediationModel)

	// Call API to Create
	return apiClient.TasksAPI.CreateTask(ctx).Body(*planModel.ToApiCreateModel(version)).Execute()
}

func (f *MalwareRemediatorTask) DoUpdateRequest(plan any, state any, apiClient *v3.APIClient, ctx context.Context, version common.SystemVersion) (*http.Response, error) {
	// Cast to correct Plan Model Type
	planModel := (plan).(model.TaskMalwareRemediationModel)

	// Cast to correct State Model Type
	stateModel := (state).(model.TaskMalwareRemediationModel)

	// Call API to Update
	return apiClient.TasksAPI.UpdateTask(ctx, stateModel.Id.ValueString()).Body(*planModel.ToApiUpdateModel(version)).Execute()
}

func (f *MalwareRemediatorTask) GetMarkdownDescription() string {
	return fmt.Sprintf(
		`Manage Task '%s' (%s)
	
This task requires the Sonatype Repository Firewall enabled with the `+"`Security-Malicious`"+` policy set to fail to function as expected.

Setting the connection to Sonatype IQ Server is a requirement forSonatype Repository Firewall to work and this task is using Firewall to generate the results.`,
		f.GetPublicName(), f.GetType().String(),
	)
}

func (f *MalwareRemediatorTask) PlanAsModel(ctx context.Context, plan tfsdk.Plan) (any, diag.Diagnostics) {
	var planModel model.TaskMalwareRemediationModel
	return planModel, plan.Get(ctx, &planModel)
}

func (f *MalwareRemediatorTask) GetPropertiesSchema() map[string]tfschema.Attribute {
	return map[string]tfschema.Attribute{
		"repository_name": schema.ResourceRequiredString(
			`The the proxy repository to remove malware from.
			
**NOTE:** This proxy repository must already be configured with the Audit & Quarantine capability - i.e. have Sonatype Repostiory Firewall configured.`,
		),
		"enable_malware_cleanup": schema.ResourceRequiredBool(
			`When enabled, malware found will be scheduled to be cleaned up in the target proxy repositories.
			
**WARNING:** Enabling automatic malware clean up may remove dependencies currently in use by your applications, this may break any automated builds 
when Sonatype Repository Firewall quarantines these components the next time they are requested.`,
		),
	}
}

func (f *MalwareRemediatorTask) StateAsModel(ctx context.Context, state tfsdk.State) (any, diag.Diagnostics) {
	var stateModel model.TaskMalwareRemediationModel
	return stateModel, state.Get(ctx, &stateModel)
}

func (f *MalwareRemediatorTask) UpdatePlanForState(plan any) any {
	var planModel = (plan).(model.TaskMalwareRemediationModel)
	planModel.LastUpdated = types.StringValue(time.Now().Format(time.RFC850))
	return planModel
}

func (f *MalwareRemediatorTask) UpdateStateFromApi(state any, api any) any {
	stateModel := (state).(model.TaskMalwareRemediationModel)
	apiModel := (api).(v3.CreateTask201Response)
	stateModel.Id = types.StringValue(apiModel.Id)
	return stateModel
}

func (f *MalwareRemediatorTask) UpdateStateFromPlanForUpdate(plan any, state any) any {
	planModel := (plan).(model.TaskMalwareRemediationModel)
	stateModel := (state).(model.TaskMalwareRemediationModel)

	planModel.Id = stateModel.Id
	planModel.LastUpdated = types.StringValue(time.Now().Format(time.RFC850))

	return planModel
}
